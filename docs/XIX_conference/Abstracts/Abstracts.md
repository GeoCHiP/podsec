
## Аннотация

*В докладе рассматриваются вопросы одной из первых реализаций rootless kubernetes в рамках ALTLinux-пакетов защиты контейнерных решений podsec (Podman Security). Сравнение rootless и rootfull решения. Особенности реализации rootless решения. Механизмы защиты от несанционированного доступа и использования уязвимостей.*

Реализация `rootless kubernetes` была сделана на основе проекта [Usernetes](https://github.com/rootless-containers/usernetes).

## Базовое решение Usernetes

![Схема разворачивания Usernetes rootless kubernetes](../Images/usernetes.drawio.png)

Отличие данного решения от стандартного `rootfull`-решения:

- Основные программы (`kube-apiserver`, `kube-controller`, `kube-scheduler`, `kube-proxy`, `coredns`, `etcd`, ...) запускаются в виде сервисов, а не в виде контейнеров.

- Сертификаты генерируются сторонней программой (`cfssl`) и помещаются в тома доступные узлам кластера.


Достоинства данного решения:
  
- Позволяет разворачивать rootless kubernetes в одноузловом или кластерном варианте.

- Обеспечивает быстрое тестирование решения путем разворачивания `rootless kubernetes` в виде стека сервисов (`docker-compose`) в рамках одного сервера.

В то же время это решение носит эксперементальный характер, что предопределили следующие 
недостатки:

- Генерация сертификатов производится программой `cfssl`, отсутствующей в репозитории пакетов `ALTLinux`.
  
- Для создания и доступа к сертификатам необходимо использовать либо `docker-тома` либо `разделяемую файловую систему`.

- Решение создается без использования стандартной команды разворачивания кластера `kubeadm`, что ограничивает варианты разворачивания решения в виде кластера.

- Решение поднимается либо в виде стека сервисов (`docker-compose`) в рамках одного сервера либо требует создание `разделяемого тома` в рамках кластера для доступа к сертификатам.

- Процедуры добавления, удаления узлов в кластер, обновления сертификатов нестандартные и требуют дополнительной квалификации от системного администратора.

- Реализация основных компонент кластера в виде сервисов, а не в виде контейнеров (`POD`'ов) несет потенциальные риски при обновлении версий `kubernetes`, так как требует анализа возможных изменений в образах новых версий `kubernetes`.

##  Стандартная схема разворачивания rootfull kubernetes кластера через команду kubeadm

Для снятия основных недостатков необходимо было реализовать на основе `Usernetes` вариант разворачивания `rootless kubernetes`-кластера через стандартную программу `kubernetes` - `kubeadm`.

Процесс разворачивания `rootfull-кластера` через `kubeadm` выгладит следующим образом:

![Схема инициализации rootfull master сервера ](../Images/rootfullInit.drawio.png)

При запуска на начальном (`Init`) `Master`(`ControlPlane`) узле `kubeadm init` производит следующие основные  действия:

- Загружает с регистратора все необходимые (`kube-apiserver`, `kube-controller`, `kube-scheduler`, `kube-proxy`, `coredns`, `etcd`, ...) `kubernetes`-образы.
``
- Запускает через `systemctl start kubelet` сервис `kubelet`.

- Генерирует сертификаты и kubernet-манифесты в каталоге `/etc/kubernetes/manifests/`.

- Поднимает через `kubelet` основные контейнеры (`POD`'ы) 


## Разворачивание rootless кластера через команду kubeadm

![Схема инициализации rootless master сервера ](../Images/rootlessInit.drawio.png)



## Ссылки

- Usernetes: Kubernetes without the root privileges - https://github.com/rootless-containers/usernetes
