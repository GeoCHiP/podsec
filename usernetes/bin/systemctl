#!/bin/sh
set -x
exec 2>>/tmp/systemctl.log

echo "

------------------ $(date)
CMD=$*
" >&2
(
userMode=
if [ $1 == '--user' ]
then
  userMode=1
  shift
fi

cmd=$1
target=$2
shift; shift

if [ "${target:0:7}" = 'kubelet' ]
then
  Target="u7s.target"
  case $cmd in
    start | restart )
      confFiles="
/etc/kubernetes/manifests/etcd.yaml
/etc/kubernetes/manifests/kube-apiserver.yaml
/etc/kubernetes/manifests/kube-controller-manager.yaml
/etc/kubernetes/manifests/kube-scheduler.yaml
/var/lib/kubelet/config.yaml
      "
      ls -l /etc/kubernetes/
      while [ ! -d /etc/kubernetes/manifests/ ];
      do
        echo "Wait /etc/kubernetes/manifests/" >&2
	ls -l /etc/kubernetes/ >&2
	sleep 1
      done
      cd /etc/kubernetes/manifests/
      ok=
      while [ -z "$ok" ]
      do
	echo "Content of /etc/kubernetes/manifests/:" >&2
	ls -l /etc/kubernetes/manifests/ >&2
        for confFile in $confFiles
        do
          if [ ! -s $confFile ]
          then
            echo "Conffile $confFile is missing or empty!!! Waiting 1 second..."
            sleep 1
            ok=''
            break
          else
            ok='yes'
          fi
        done
      done
      echo "START $target"
      /sbin/systemctl --user -M u7s-admin@ -T $cmd $target $@
      /sbin/systemctl --user -M u7s-admin@ -T $cmd $Target
      exit 0
    ;;
  esac

fi
)&
/sbin/systemctl --user -M u7s-admin@ -T $cmd $target $@

